name: Update AUP Data

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '0 */3 * * *'  # –ö–∞–∂–¥—ã–µ 3 —á–∞—Å–∞

permissions:
  contents: write  # –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è git push

jobs:
  update-aup:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üêç Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: ‚ñ∂Ô∏è Run aup_upload.py
        env:
          XML_DATA_URL: ${{ secrets.XML_DATA_URL }}
          USE_PROXY: ${{ secrets.USE_PROXY }}  # –î–æ–ª–∂–µ–Ω –±—ã—Ç—å "true" –∏–ª–∏ "false"
          HTTP_PROXY: ${{ secrets.HTTP_PROXY }}
          HTTPS_PROXY: ${{ secrets.HTTPS_PROXY }}
        run: python aup_upload.py

      - name: ‚úÖ Verify output.json
        run: |
          if [[ ! -f output.json ]]; then
            echo "‚ùå output.json –Ω–µ —Å–æ–∑–¥–∞–Ω"
            exit 1
          fi
          if [[ ! -s output.json ]]; then
            echo "‚ùå output.json –ø—É—Å—Ç"
            exit 1
          fi
          echo "‚úÖ output.json —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω:"
          cat output.json

      - name: üíæ Commit and push output.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add output.json
          git diff --staged --quiet || git commit -m "chore: update AUP data $(date -u +'%Y-%m-%d %H:%M UTC')"
          git push

      - name: üì§ Upload as artifact (for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: aup-output
          path: output.json
